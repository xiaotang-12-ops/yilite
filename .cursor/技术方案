





























å®Œç¾ï¼å°ç³–ï¼Œæˆ‘å·²ç»å®Œæˆäº†æ·±åº¦åˆ†æï¼Œç°åœ¨ç»™ä½ ç”Ÿæˆä¸€ä»½å®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£ï¼š

---

# ğŸš€ å•æ–‡ä»¶æµç¨‹ç®€åŒ–æŠ€æœ¯æ–¹æ¡ˆ

**ç‰ˆæœ¬ï¼š** v1.0  
**æ—¥æœŸï¼š** 2025-11-27  
**ä½œè€…ï¼š** Augment AI  
**ç›®æ ‡ï¼š** ç®€åŒ–å•æ–‡ä»¶è£…é…æ‰‹å†Œç”Ÿæˆæµç¨‹ï¼Œæå‡æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§

---

## ğŸ“‹ ç›®å½•

1. [èƒŒæ™¯å’Œç›®æ ‡](#èƒŒæ™¯å’Œç›®æ ‡)
2. [ç°çŠ¶åˆ†æ](#ç°çŠ¶åˆ†æ)
3. [æŠ€æœ¯æ–¹æ¡ˆ](#æŠ€æœ¯æ–¹æ¡ˆ)
4. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
5. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)
6. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
7. [ç›‘æ§å’Œå›é€€](#ç›‘æ§å’Œå›é€€)

---

## 1. èƒŒæ™¯å’Œç›®æ ‡

### 1.1 èƒŒæ™¯
å½“å‰ç³»ç»Ÿè®¾è®¡ä¸ºæ”¯æŒ"å¤šæ–‡ä»¶å¤šå±‚çº§"åœºæ™¯ï¼ˆäº§å“å›¾+å¤šä¸ªç»„ä»¶å›¾ï¼‰ï¼Œä½†å®é™…ä½¿ç”¨ä¸­ï¼š
- **100%çš„ç”¨æˆ·**åªä¸Šä¼ 1ä¸ªPDF + 1ä¸ªSTEP
- **0%çš„ç”¨æˆ·**ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
- ç³»ç»Ÿä»ç„¶æŒ‰"å¤šæ–‡ä»¶"é€»è¾‘å¤„ç†ï¼Œå¯¼è‡´æµç¨‹å¤æ‚ã€æ€§èƒ½æµªè´¹

### 1.2 ç›®æ ‡
- âœ… **ç®€åŒ–æµç¨‹**ï¼šå»æ‰ä¸å¿…è¦çš„åˆ†ç±»ã€åˆ¤æ–­ã€å¾ªç¯é€»è¾‘
- âœ… **æå‡æ€§èƒ½**ï¼šå‡å°‘AIè°ƒç”¨æ¬¡æ•°å’Œå¤„ç†æ—¶é—´ï¼ˆé¢„è®¡æå‡30-40%ï¼‰
- âœ… **æé«˜ç¨³å®šæ€§**ï¼šå‡å°‘åˆ†æ”¯é€»è¾‘ï¼Œé™ä½å‡ºé”™æ¦‚ç‡ï¼ˆé¢„è®¡é™ä½50%ï¼‰
- âœ… **å¢å¼ºå¯ç»´æŠ¤æ€§**ï¼šä»£ç é‡å‡å°‘37%ï¼Œé€»è¾‘æ›´æ¸…æ™°

### 1.3 éç›®æ ‡
- âŒ ä¸æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼ˆæœªæ¥å¦‚éœ€æ”¯æŒï¼Œéœ€è¦é‡æ–°è®¾è®¡ï¼‰
- âŒ ä¸ä¿®æ”¹å‰ç«¯ä¸Šä¼ ç•Œé¢ï¼ˆä¿æŒ1ä¸ªPDF + 1ä¸ªSTEPçš„é™åˆ¶ï¼‰
- âŒ ä¸è¿ç§»æ—§æ•°æ®ï¼ˆå‰ç«¯é€šè¿‡é€‚é…å™¨å…¼å®¹ï¼‰

---

## 2. ç°çŠ¶åˆ†æ

### 2.1 å½“å‰æµç¨‹å›¾

```mermaid
graph TD
    A[ç”¨æˆ·ä¸Šä¼ 1ä¸ªPDF + 1ä¸ªSTEP] --> B[æ–‡ä»¶åˆ†ç±»å™¨]
    B --> C{åˆ¤æ–­äº§å“å›¾/ç»„ä»¶å›¾}
    C -->|äº§å“å›¾| D[äº§å“æ¨¡å¼]
    C -->|ç»„ä»¶å›¾| E[ç»„ä»¶æ¨¡å¼]
    D --> F[å¾ªç¯æå–BOM]
    E --> F
    F --> G[å±‚çº§BOMåŒ¹é…å™¨]
    G --> H{åˆ¤æ–­æ¨¡å¼}
    H -->|ç»„ä»¶æ¨¡å¼| I[Agent3: ç»„ä»¶è£…é…]
    H -->|äº§å“æ¨¡å¼| J[Agent3 + Agent4]
    I --> K[è¾“å‡ºJSON]
    J --> K
```

### 2.2 é—®é¢˜ç‚¹

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| æ–‡ä»¶åˆ†ç±»é€»è¾‘å¤šä½™ | å¢åŠ å¤„ç†æ—¶é—´å’Œå¤æ‚åº¦ | ä¸­ |
| å¾ªç¯å¤„ç†å•ä¸ªæ–‡ä»¶ | ä»£ç å†—ä½™ï¼Œæ€§èƒ½æµªè´¹ | ä¸­ |
| æ¨¡å¼åˆ¤å®šå¯èƒ½è¯¯åˆ¤ | å¯¼è‡´ç”Ÿæˆé”™è¯¯çš„æ­¥éª¤ç»“æ„ | é«˜ |
| å±‚çº§åŒ¹é…å™¨è¿‡åº¦è®¾è®¡ | å•å±‚BOMç”¨å¤šå±‚åŒ¹é…å™¨ï¼Œæ•ˆç‡ä½ | ä¸­ |
| Agentè°ƒç”¨ä¸ç¡®å®š | æœ‰æ—¶è°ƒ2ä¸ªï¼Œæœ‰æ—¶è°ƒ3ä¸ªï¼Œéš¾ä»¥é¢„æµ‹ | é«˜ |
| è¾“å‡ºç»“æ„ä¸ä¸€è‡´ | å‰ç«¯éœ€è¦å¤„ç†å¤šç§æƒ…å†µ | ä¸­ |

### 2.3 ä»£ç å¤æ‚åº¦åˆ†æ

| æ–‡ä»¶ | å½“å‰è¡Œæ•° | å¤æ‚åº¦ | é—®é¢˜ |
|------|----------|--------|------|
| `file_classifier.py` | 316 | é«˜ | å¤§é‡åˆ†ç±»é€»è¾‘ |
| `gemini_pipeline.py` | 1084 | æé«˜ | å¤šåˆ†æ”¯ã€å¤šå¾ªç¯ |
| `hierarchical_bom_matcher_v2.py` | 450 | é«˜ | å±‚çº§åŒ¹é…å¤æ‚ |
| `agent_1_vision_planning.py` | 180 | ä¸­ | åŠŸèƒ½é‡å¤ |
| `agent_3_component_assembly.py` | 220 | ä¸­ | - |
| `agent_4_product_assembly.py` | 200 | ä¸­ | ä¸agent_3é‡å¤ |
| **æ€»è®¡** | **2450** | - | - |

---

## 3. æŠ€æœ¯æ–¹æ¡ˆ

### 3.1 æ–°æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[ç”¨æˆ·ä¸Šä¼ 1ä¸ªPDF + 1ä¸ªSTEP] --> B[FileHandler: æ–‡ä»¶è¯†åˆ«]
    B --> C[BOMæå–å™¨]
    C --> D[FlatBOMMatcher: æ‰å¹³åŒ¹é…]
    D --> E[AssemblyAgent: ç»Ÿä¸€è£…é…è§„åˆ’]
    E --> F[WeldingAgent: ç„Šæ¥å·¥è‰º]
    F --> G[SafetyAgent: å®‰å…¨æ£€æŸ¥]
    G --> H[è¾“å‡ºç»Ÿä¸€JSON]
```

**æ ¸å¿ƒæ”¹è¿›ï¼š**
- ğŸ”¥ å»æ‰æ–‡ä»¶åˆ†ç±»å™¨[object Object]æ‰æ¨¡å¼åˆ¤å®š
- ğŸ”¥ å»æ‰å¾ªç¯å¤„ç†
- ğŸ”¥ å»æ‰å±‚çº§åŒ¹é…[object Object]å¹¶è£…é…Agent

---

### 3.2 æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 3.2.1 FileHandlerï¼ˆæ–‡ä»¶å¤„ç†å™¨ï¼‰

**æ–‡ä»¶ï¼š** `core/file_handler.py`

**èŒè´£ï¼š** ç®€å•çš„æ–‡ä»¶è¯†åˆ«å’Œè·¯å¾„è·å–ï¼ˆä¸åšåˆ†ç±»åˆ¤æ–­ï¼‰

**æ¥å£è®¾è®¡ï¼š**
```python
class FileHandler:
    def __init__(self, task_id: str):
        self.task_id = task_id
        self.base_path = f"tasks/{task_id}"
    
    def get_files(self) -> Dict[str, Any]:
        """
        è·å–ä»»åŠ¡æ–‡ä»¶
        
        è¿”å›ï¼š
        {
            "pdf_file": "path/to/drawing.pdf",
            "step_file": "path/to/model.step",  # æˆ–æ–‡ä»¶å¤¹
            "images": ["img1.jpg", "img2.jpg"]
        }
        """
        pass
    
    def extract_step_parts(self, step_path: str) -> List[str]:
        """
        æå–STEPé›¶ä»¶åˆ—è¡¨
        
        - å¦‚æœæ˜¯å•ä¸ªSTEPæ–‡ä»¶ â†’ ä½¿ç”¨OCPè§£æ
        - å¦‚æœæ˜¯STEPæ–‡ä»¶å¤¹ â†’ åˆ—å‡ºæ‰€æœ‰.stepæ–‡ä»¶
        """
        pass
```

**ä»£ç é‡ï¼š** çº¦80è¡Œï¼ˆvs æ—§çš„316è¡Œï¼‰

---

#### 3.2.2 FlatBOMMatcherï¼ˆæ‰å¹³BOMåŒ¹é…å™¨ï¼‰

**æ–‡ä»¶ï¼š** `core/bom_matcher.py`

**èŒè´£ï¼š** ç®€å•çš„BOMé¡¹ä¸STEPæ–‡ä»¶åŒ¹é…ï¼ˆä¸åšå±‚çº§åˆ¤æ–­ï¼‰

**æ¥å£è®¾è®¡ï¼š**
```python
class FlatBOMMatcher:
    def match(self, bom_items: List[Dict], step_files: List[str]) -> List[Dict]:
        """
        æ‰å¹³åŒ¹é…ï¼šBOMé¡¹ â†” STEPæ–‡ä»¶
        
        åŒ¹é…ç­–ç•¥ï¼š
        1. ç²¾ç¡®åŒ¹é…ï¼šBOMåç§° == STEPæ–‡ä»¶åï¼ˆå»æ‰©å±•åï¼‰
        2. æ¨¡ç³ŠåŒ¹é…ï¼šä½¿ç”¨difflib.SequenceMatcher
        3. æ•°é‡éªŒè¯ï¼šæ£€æŸ¥BOMæ•°é‡ä¸STEPæ•°é‡
        
        è¿”å›ï¼š
        [
            {
                "bom_name": "åº•æ¿",
                "bom_quantity": 1,
                "bom_material": "Q235",
                "matched_file": "åº•æ¿.step",
                "match_confidence": 1.0
            },
            ...
        ]
        """
        pass
```

**åŒ¹é…ç®—æ³•ï¼š**
```python
def _calculate_similarity(self, bom_name: str, file_name: str) -> float:
    """
    è®¡ç®—ç›¸ä¼¼åº¦
    
    1. å»é™¤æ‰©å±•å
    2. å»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
    3. è½¬å°å†™
    4. ä½¿ç”¨SequenceMatcherè®¡ç®—ç›¸ä¼¼åº¦
    """
    from difflib import SequenceMatcher
    
    clean_bom = self._clean_name(bom_name)
    clean_file = self._clean_name(file_name)
    
    return SequenceMatcher(None, clean_bom, clean_file).ratio()
```

**ä»£ç é‡ï¼š** çº¦150è¡Œï¼ˆvs æ—§çš„450è¡Œï¼‰

---

#### 3.2.3 AssemblyAgentï¼ˆç»Ÿä¸€è£…é…Agentï¼‰

**æ–‡ä»¶ï¼š** `prompts/agent_assembly.py`

**èŒè´£ï¼š** ç»Ÿä¸€çš„è£…é…æ­¥éª¤è§„åˆ’ï¼ˆä¸åŒºåˆ†ç»„ä»¶/äº§å“ï¼‰

**Promptè®¾è®¡ï¼š**
```python
ASSEMBLY_PROMPT = """
ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„è£…é…å·¥ç¨‹å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯è§„åˆ’è£…é…æ­¥éª¤ï¼š

## è¾“å…¥ä¿¡æ¯
1. **BOMæ¸…å•**ï¼š{bom_items}
2. **3Dæ¨¡å‹é›¶ä»¶**ï¼š{step_parts}
3. **è£…é…å›¾çº¸**ï¼š{images}

## ä»»åŠ¡è¦æ±‚
1. åˆ†æé›¶ä»¶ä¹‹é—´çš„è£…é…å…³ç³»
2. ç¡®å®šè£…é…åŸºå‡†ä»¶ï¼ˆé€šå¸¸æ˜¯æœ€å¤§çš„ã€å›ºå®šçš„é›¶ä»¶ï¼‰
3. è§„åˆ’åˆç†çš„è£…é…é¡ºåºï¼š
   - åŸºå‡†ä»¶ â†’ ä¸»è¦ç»“æ„ä»¶ â†’ æ¬¡è¦é›¶ä»¶ â†’ ç´§å›ºä»¶
   - è€ƒè™‘ç„Šæ¥å·¥åºçš„ä½ç½®ï¼ˆç‚¹ç„Šå®šä½ â†’ è£…é… â†’ æœ€ç»ˆç„Šæ¥ï¼‰
4. ä¸ºæ¯ä¸ªæ­¥éª¤æŒ‡å®šï¼š
   - éœ€è¦çš„é›¶ä»¶
   - éœ€è¦çš„å·¥å…·
   - æ“ä½œè¯´æ˜
   - æ³¨æ„äº‹é¡¹

## è¾“å‡ºæ ¼å¼
{
  "assembly_steps": [
    {
      "step_id": "step_1",
      "description": "å®‰è£…åº•æ¿ä½œä¸ºåŸºå‡†ä»¶",
      "parts": ["åº•æ¿"],
      "tools": ["æ°´å¹³ä»ª", "å«é“"],
      "operations": ["å°†åº•æ¿æ”¾ç½®åœ¨å·¥ä½œå°ä¸Š", "ä½¿ç”¨æ°´å¹³ä»ªè°ƒæ•´æ°´å¹³"],
      "precautions": ["ç¡®ä¿åº•æ¿æ°´å¹³", "æ£€æŸ¥è¡¨é¢æ— æ¯›åˆº"],
      "estimated_time": "10åˆ†é’Ÿ"
    },
    ...
  ]
}
"""
```

**è¾“å…¥æ•°æ®ç»“æ„ï¼š**
```python
{
    "bom_items": [
        {"name": "åº•æ¿", "quantity": 1, "material": "Q235", "spec": "500Ã—300Ã—10"},
        {"name": "å·¦æŒ‚ä»¶", "quantity": 1, "material": "Q235", "spec": "200Ã—150Ã—8"},
        ...
    ],
    "step_parts": ["åº•æ¿.step", "å·¦æŒ‚ä»¶.step", ...],
    "images": ["base64_image_1", "base64_image_2", ...]
}
```

**è¾“å‡ºæ•°æ®ç»“æ„ï¼š**
```python
{
    "assembly_steps": [
        {
            "step_id": "step_1",
            "description": "å®‰è£…åº•æ¿ä½œä¸ºåŸºå‡†ä»¶",
            "parts": ["åº•æ¿"],
            "tools": ["æ°´å¹³ä»ª", "å«é“"],
            "operations": ["å°†åº•æ¿æ”¾ç½®åœ¨å·¥ä½œå°ä¸Š", "ä½¿ç”¨æ°´å¹³ä»ªè°ƒæ•´æ°´å¹³"],
            "precautions": ["ç¡®ä¿åº•æ¿æ°´å¹³", "æ£€æŸ¥è¡¨é¢æ— æ¯›åˆº"],
            "estimated_time": "10åˆ†é’Ÿ",
            "images": [0, 1]  # å¼•ç”¨è¾“å…¥å›¾ç‰‡çš„ç´¢å¼•
        },
        ...
    ]
}
```

**ä»£ç é‡ï¼š** çº¦200è¡Œ

---

#### 3.2.4 GeminiPipelineï¼ˆä¸»æµç¨‹æ§åˆ¶å™¨ï¼‰

**æ–‡ä»¶ï¼š** `core/gemini_pipeline.py`

**æ–°æµç¨‹ï¼š**
```python
class GeminiPipeline:
    async def generate_manual(self, task_id: str) -> Dict:
        """
        ç”Ÿæˆè£…é…æ‰‹å†Œï¼ˆæ–°æµç¨‹ï¼‰
        """
        logger.info(f"å¼€å§‹ç”Ÿæˆè£…é…æ‰‹å†Œ: {task_id}")
        monitor = PerformanceMonitor()
        
        # 1. æ–‡ä»¶å¤„ç†
        start = time.time()
        file_handler = FileHandler(task_id)
        files = file_handler.get_files()
        monitor.record("file_handling", time.time() - start)
        logger.info(f"âœ… æ–‡ä»¶è¯†åˆ«å®Œæˆ: PDF={files['pdf_file']}, STEP={files['step_file']}")
        
        # 2. BOMæå–
        start = time.time()
        bom_extractor = BOMExtractor()
        bom_items = await bom_extractor.extract(
            pdf_path=files['pdf_file'],
            images=files['images']
        )
        monitor.record("bom_extraction", time.time() - start)
        logger.info(f"âœ… BOMæå–å®Œæˆ: {len(bom_items)}ä¸ªé›¶ä»¶")
        
        # 3. BOMåŒ¹é…
        start = time.time()
        matcher = FlatBOMMatcher()
        step_parts = file_handler.extract_step_parts(files['step_file'])
        matched_bom = matcher.match(bom_items, step_parts)
        monitor.record("bom_matching", time.time() - start)
        logger.info(f"âœ… BOMåŒ¹é…å®Œæˆ: {len(matched_bom)}ä¸ªåŒ¹é…é¡¹")
        
        # 4. è£…é…æ­¥éª¤ç”Ÿæˆ
        start = time.time()
        assembly_agent = AssemblyAgent()
        assembly_result = await assembly_agent.generate(
            bom_items=matched_bom,
            step_parts=step_parts,
            images=files['images']
        )
        monitor.record("assembly_planning", time.time() - start)
        logger.info(f"âœ… è£…é…è§„åˆ’å®Œæˆ: {len(assembly_result['assembly_steps'])}ä¸ªæ­¥éª¤")
        
        # 5. ç„Šæ¥å·¥è‰ºåˆ†æ
        start = time.time()
        welding_agent = WeldingAgent()
        welding_result = await welding_agent.analyze(
            bom_items=matched_bom,
            assembly_steps=assembly_result['assembly_steps'],
            images=files['images']
        )
        monitor.record("welding_analysis", time.time() - start)
        logger.info(f"âœ… ç„Šæ¥å·¥è‰ºåˆ†æå®Œæˆ")
        
        # 6. å®‰å…¨æ£€æŸ¥
        start = time.time()
        safety_agent = SafetyAgent()
        safety_result = await safety_agent.check(
            assembly_steps=assembly_result['assembly_steps'],
            welding_info=welding_result
        )
        monitor.record("safety_check", time.time() - start)
        logger.info(f"âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ")
        
        # 7. åˆå¹¶ç»“æœ
        manual = {
            "version": "2.0",  # ç‰ˆæœ¬æ ‡è®°
            "product_name": self._extract_product_name(files['pdf_file']),
            "assembly_steps": assembly_result['assembly_steps'],
            "welding": welding_result,
            "safety": safety_result,
            "bom": matched_bom,
            "metadata": {
                "generated_at": datetime.now().isoformat(),
                "performance": monitor.summary()
            }
        }
        
        # 8. ä¿å­˜ç»“æœ
        self._save_manual(task_id, manual)
        
        logger.info(f"âœ… è£…é…æ‰‹å†Œç”Ÿæˆå®Œæˆï¼Œæ€»è€—æ—¶: {monitor.summary()['total_time']:.2f}ç§’")
        return manual
```

**ä»£ç é‡ï¼š** çº¦600è¡Œï¼ˆvs æ—§çš„1084è¡Œï¼‰

---

### 3.3 æ•°æ®ç»“æ„å˜åŒ–

#### 3.3.1 æ—§æ•°æ®ç»“æ„ï¼ˆv1.0ï¼‰
```json
{
  "product_name": "æŒ‚ä»¶æ€»æˆ",
  "components": [
    {
      "component_id": "comp_1",
      "component_name": "ç»„ä»¶1",
      "steps": [
        {"step_id": "comp_1_step_1", "description": "..."}
      ]
    }
  ],
  "product_assembly_steps": [
    {"step_id": "prod_step_1", "description": "..."}
  ],
  "welding": {...},
  "safety": {...}
}
```

#### 3.3.2 æ–°æ•°æ®ç»“æ„ï¼ˆv2.0ï¼‰
```json
{
  "version": "2.0",
  "product_name": "æŒ‚ä»¶æ€»æˆ",
  "assembly_steps": [
    {
      "step_id": "step_1",
      "description": "å®‰è£…åº•æ¿ä½œä¸ºåŸºå‡†ä»¶",
      "parts": ["åº•æ¿"],
      "tools": ["æ°´å¹³ä»ª", "å«é“"],
      "operations": ["å°†åº•æ¿æ”¾ç½®åœ¨å·¥ä½œå°ä¸Š", "ä½¿ç”¨æ°´å¹³ä»ªè°ƒæ•´æ°´å¹³"],
      "precautions": ["ç¡®ä¿åº•æ¿æ°´å¹³", "æ£€æŸ¥è¡¨é¢æ— æ¯›åˆº"],
      "estimated_time": "10åˆ†é’Ÿ",
      "images": [0, 1]
    },
    {
      "step_id": "step_2",
      "description": "å®‰è£…å·¦å³æŒ‚ä»¶å¹¶ç‚¹ç„Šå®šä½",
      "parts": ["å·¦æŒ‚ä»¶", "å³æŒ‚ä»¶"],
      "tools": ["ç‚¹ç„Šé’³", "è§’å°º", "å¤¹å…·"],
      "operations": ["..."],
      "precautions": ["..."],
      "estimated_time": "20åˆ†é’Ÿ",
      "images": [2, 3]
    }
  ],
  "welding": {...},
  "safety": {...},
  "bom": [
    {
      "bom_name": "åº•æ¿",
      "bom_quantity": 1,
      "bom_material": "Q235",
      "matched_file": "åº•æ¿.step",
      "match_confidence": 1.0
    }
  ],
  "metadata": {
    "generated_at": "2025-11-27T11:15:00Z",
    "performance": {
      "total_time": 45.2,
      "stages": {
        "file_handling": 0.5,
        "bom_extraction": 12.3,
        "bom_matching": 1.2,
        "assembly_planning": 18.5,
        "welding_analysis": 8.7,
        "safety_check": 4.0
      }
    }
  }
}
```

**å…³é”®å˜åŒ–ï¼š**
- âœ… æ·»åŠ `version`å­—æ®µæ ‡è®°ç‰ˆæœ¬
- âœ… `components`æ•°ç»„ â†’ `assembly_steps`æ•°ç»„ï¼ˆæ‰å¹³åŒ–ï¼‰
- âœ… åˆ é™¤`product_assembly_steps`ï¼ˆåˆå¹¶åˆ°assembly_stepsï¼‰
- âœ… æ·»åŠ `bom`å­—æ®µï¼ˆåŒ…å«åŒ¹é…ä¿¡æ¯ï¼‰
- âœ… æ·»åŠ `metadata`å­—æ®µï¼ˆåŒ…å«æ€§èƒ½æ•°æ®ï¼‰

---

### 3.4 å‰ç«¯é€‚é…

#### 3.4.1 ç±»å‹å®šä¹‰æ›´æ–°

**æ–‡ä»¶ï¼š** `frontend/src/types/manual.ts`

```typescript
// æ–°å¢ç‰ˆæœ¬å­—æ®µ
export interface Manual {
  version?: string;  // "1.0" æˆ– "2.0"
  product_name: string;
  
  // v1.0å­—æ®µï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
  components?: Array<{
    component_id: string;
    component_name: string;
    steps: AssemblyStep[];
  }>;
  product_assembly_steps?: AssemblyStep[];
  
  // v2.0å­—æ®µï¼ˆæ–°æ•°æ®ï¼‰
  assembly_steps?: AssemblyStep[];
  bom?: BOMItem[];
  
  welding: WeldingInfo;
  safety: SafetyInfo;
  metadata?: {
    generated_at: string;
    performance: PerformanceMetrics;
  };
}

export interface AssemblyStep {
  step_id: string;
  description: string;
  parts: string[];
  tools: string[];
  operations?: string[];
  precautions?: string[];
  estimated_time?: string;
  images?: number[];
}

export interface BOMItem {
  bom_name: string;
  bom_quantity: number;
  bom_material?: string;
  matched_file?: string;
  match_confidence?: number;
}
```

#### 3.4.2 æ•°æ®é€‚é…å™¨

**æ–‡ä»¶ï¼š** `frontend/src/utils/manualAdapter.ts`

```typescript
export function adaptManualData(manual: any): Manual {
  // æ£€æŸ¥ç‰ˆæœ¬
  const version = manual.version || "1.0";
  
  if (version === "2.0") {
    // æ–°æ ¼å¼ï¼Œç›´æ¥è¿”å›
    return manual as Manual;
  }
  
  // æ—§æ ¼å¼ï¼Œéœ€è¦é€‚é…
  const adaptedManual: Manual = {
    ...manual,
    version: "1.0",
    assembly_steps: []
  };
  
  // åˆå¹¶componentså’Œproduct_assembly_steps
  if (manual.components && manual.components.length > 0) {
    adaptedManual.assembly_steps = manual.components[0].steps || [];
  }
  
  if (manual.product_assembly_steps) {
    adaptedManual.assembly_steps = [
      ...(adaptedManual.assembly_steps || []),
      ...manual.product_assembly_steps
    ];
  }
  
  return adaptedManual;
}
```

#### 3.4.3 ManualVieweræ›´æ–°

**æ–‡ä»¶ï¼š** `frontend/src/components/ManualViewer.tsx`

```typescript
import { adaptManualData } from '../utils/manualAdapter';

export function ManualViewer({ manualData }: { manualData: any }) {
  // é€‚é…æ•°æ®
  const manual = adaptManualData(manualData);
  
  return (
    <div className="manual-viewer">
      <h1>{manual.product_name}</h1>
      
      {/* è£…é…æ­¥éª¤ */}
      <section className="assembly-steps">
        <h2>è£…é…æ­¥éª¤</h2>
        {manual.assembly_steps?.map((step, index) => (
          <StepCard key={step.step_id} step={step} index={index + 1} />
        ))}
      </section>
      
      {/* BOMæ¸…å•ï¼ˆä»…v2.0ï¼‰ */}
      {manual.version === "2.0" && manual.bom && (
        <section className="bom-list">
          <h2>é›¶ä»¶æ¸…å•</h2>
          <BOMTable items={manual.bom} />
        </section>
      )}
      
      {/* ç„Šæ¥å·¥è‰º */}
      <section className="welding">
        <h2>ç„Šæ¥å·¥è‰º</h2>
        <WeldingInfo data={manual.welding} />
      </section>
      
      {/* å®‰å…¨æ³¨æ„äº‹é¡¹ */}
      <section className="safety">
        <h2>å®‰å…¨æ³¨æ„äº‹é¡¹</h2>
        <SafetyInfo data={manual.safety} />
      </section>
      
      {/* æ€§èƒ½æ•°æ®ï¼ˆä»…v2.0ï¼Œå¼€å‘æ¨¡å¼ï¼‰ */}
      {process.env.NODE_ENV === 'development' && manual.metadata && (
        <section className="metadata">
          <h2>ç”Ÿæˆä¿¡æ¯</h2>
          <PerformanceMetrics data={manual.metadata.performance} />
        </section>
      )}
    </div>
  );
}
```

---

## 4. å®æ–½è®¡åˆ’

### 4.1 æ—¶é—´çº¿ï¼ˆ7å¤©ï¼‰

```mermaid
gantt
    title å•æ–‡ä»¶æµç¨‹ç®€åŒ–å®æ–½è®¡åˆ’
    dateFormat  YYYY-MM-DD
    section å‡†å¤‡é˜¶æ®µ
    åˆ›å»ºåˆ†æ”¯å’Œå¤‡ä»½           :2025-11-27, 1d
    å‡†å¤‡æµ‹è¯•æ•°æ®             :2025-11-27, 1d
    section åç«¯å¼€å‘
    åˆ›å»ºAssemblyAgent       :2025-11-28, 1d
    åˆ›å»ºBOMMatcher          :2025-11-29, 1d
    åˆ›å»ºFileHandler         :2025-11-30, 1d
    é‡æ„GeminiPipeline      :2025-12-01, 1d
    é›†æˆæµ‹è¯•                :2025-12-02, 1d
    section å‰ç«¯å¼€å‘
    å‰ç«¯é€‚é…                :2025-12-03, 1d
    section ä¸Šçº¿
    ç°åº¦å‘å¸ƒå’Œç›‘æ§          :2025-12-04, 1d
```

### 4.2 è¯¦ç»†æ­¥éª¤

#### Phase 1: å‡†å¤‡é˜¶æ®µï¼ˆDay 1 - 2025-11-27ï¼‰

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] åˆ›å»ºfeatureåˆ†æ”¯ï¼š`git checkout -b feature/simplify-single-file-pipeline`
- [ ] å¤‡ä»½å…³é”®æ–‡ä»¶åˆ°`backup/`ç›®å½•
- [ ] å‡†å¤‡æµ‹è¯•æ•°æ®ï¼š
  - [ ] æŒ‚ä»¶æ€»æˆæ¡ˆä¾‹ï¼ˆPDF + STEP + å›¾ç‰‡ï¼‰
  - [ ] é¢„æœŸè¾“å‡ºJSON
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹æ¡†æ¶ï¼š
  - [ ] `tests/test_file_handler.py`
  - [ ] `tests/test_bom_matcher.py`
  - [ ] `tests/test_assembly_agent.py`
  - [ ] `tests/test_pipeline_new.py`

---

#### Phase 2: æ ¸å¿ƒæ¨¡å—å¼€å‘ï¼ˆDay 2-4ï¼‰

**Day 2 (2025-11-28): åˆ›å»ºAssemblyAgent**
- [ ] åˆ›å»º`prompts/agent_assembly.py`
- [ ] è®¾è®¡Promptï¼ˆå‚è€ƒ3.2.3èŠ‚ï¼‰
- [ ] å®ç°Agentè°ƒç”¨é€»è¾‘
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•é€šè¿‡ç‡ï¼š>90%

**Day 3 (2025-11-29): åˆ›å»ºBOMMatcher**
- [ ] åˆ›å»º`core/bom_matcher.py`
- [ ] å®ç°æ‰å¹³åŒ¹é…ç®—æ³•
- [ ] å®ç°ç›¸ä¼¼åº¦è®¡ç®—
- [ ] å¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆæœªåŒ¹é…ã€ä¸€å¯¹å¤šï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•é€šè¿‡ç‡ï¼š>90%

**Day 4 (2025-11-30): åˆ›å»ºFileHandler**
- [ ] åˆ›å»º`core/file_handler.py`
- [ ] å®ç°æ–‡ä»¶è¯†åˆ«é€»è¾‘
- [ ] å®ç°STEPé›¶ä»¶æå–
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•é€šè¿‡ç‡ï¼š>90%

---

#### Phase 3: ä¸»æµç¨‹é‡æ„ï¼ˆDay 5-6ï¼‰

**Day 5 (2025-12-01): é‡æ„GeminiPipeline**
- [ ] åœ¨`gemini_pipeline.py`ä¸­æ·»åŠ æ–°æµç¨‹æ–¹æ³•
- [ ] æ·»åŠ é…ç½®å¼€å…³ï¼š`USE_NEW_PIPELINE`
- [ ] é›†æˆæ–°æ¨¡å—ï¼ˆFileHandler, BOMMatcher, AssemblyAgentï¼‰
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§
- [ ] æ·»åŠ è¯¦ç»†æ—¥å¿—
- [ ] ä¿ç•™æ—§æµç¨‹ä»£ç ï¼ˆæ ‡è®°ä¸ºdeprecatedï¼‰

**Day 6 (2025-12-02): é›†æˆæµ‹è¯•**
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆå¯¹æ¯”æ–°æ—§æµç¨‹ï¼‰
- [ ] è¾“å‡ºæ ¼å¼éªŒè¯
- [ ] ä¿®å¤å‘ç°çš„bug
- [ ] æµ‹è¯•é€šè¿‡ç‡ï¼š>95%

---

#### Phase 4: å‰ç«¯é€‚é…ï¼ˆDay 7ï¼‰

**Day 7 (2025-12-03): å‰ç«¯ä¿®æ”¹**
- [ ] æ›´æ–°`types/manual.ts`
- [ ] åˆ›å»º`utils/manualAdapter.ts`
- [ ] æ›´æ–°`ManualViewer.tsx`
- [ ] æµ‹è¯•æ—§æ•°æ®å…¼å®¹æ€§
- [ ] æµ‹è¯•æ–°æ•°æ®æ˜¾ç¤º
- [ ] UIæµ‹è¯•é€šè¿‡

---

#### Phase 5: ä¸Šçº¿å’Œç›‘æ§ï¼ˆDay 8ï¼‰

**Day 8 (2025-12-04): ç°åº¦å‘å¸ƒ**
- [ ] è®¾ç½®`USE_NEW_PIPELINE=true`
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- [ ] ç”Ÿæˆ3-5ä¸ªæµ‹è¯•ä»»åŠ¡
- [ ] ç›‘æ§é”™è¯¯æ—¥å¿—
- [ ] æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ
- [ ] å†³å®šï¼šå…¨é‡å‘å¸ƒ or å›é€€

---

### 4.3 æ–‡ä»¶å˜æ›´æ¸…å•

#### æ–°å¢æ–‡ä»¶
```
core/
  â”œâ”€â”€ file_handler.py          [æ–°å¢, çº¦80è¡Œ]
  â””â”€â”€ bom_matcher.py           [æ–°å¢, çº¦150è¡Œ]

prompts/
  â””â”€â”€ agent_assembly.py        [æ–°å¢, çº¦200è¡Œ]

tests/
  â”œâ”€â”€ test_file_handler.py     [æ–°å¢]
  â”œâ”€â”€ test_bom_matcher.py      [æ–°å¢]
  â”œâ”€â”€ test_assembly_agent.py   [æ–°å¢]
  â””â”€â”€ test_pipeline_new.py     [æ–°å¢]

frontend/src/
  â””â”€â”€ utils/
      â””â”€â”€ manualAdapter.ts     [æ–°å¢]
```

#### ä¿®æ”¹æ–‡ä»¶
```
core/
  â””â”€â”€ gemini_pipeline.py       [ä¿®æ”¹, 1084è¡Œ â†’ çº¦600è¡Œ]

frontend/src/
  â”œâ”€â”€ types/manual.ts          [ä¿®æ”¹, æ·»åŠ æ–°ç±»å‹]
  â””â”€â”€ components/
      â””â”€â”€ ManualViewer.tsx     [ä¿®æ”¹, æ·»åŠ é€‚é…å™¨]

.env                           [ä¿®æ”¹, æ·»åŠ USE_NEW_PIPELINE]
```

#### åˆ é™¤/å¼ƒç”¨æ–‡ä»¶ï¼ˆæš‚æ—¶ä¿ç•™ï¼‰
```
core/
  â”œâ”€â”€ file_classifier.py       [å¼ƒç”¨, æ ‡è®°@deprecated]
  â””â”€â”€ hierarchical_bom_matcher_v2.py  [å¼ƒç”¨]

prompts/
  â”œâ”€â”€ agent_1_vision_planning.py      [å¼ƒç”¨]
  â””â”€â”€ agent_4_product_assembly.py     [å¼ƒç”¨]
```

---

## 5. é£é™©è¯„ä¼°

### 5.1 é£é™©çŸ©é˜µ

| é£é™© | æ¦‚ç‡ | å½±å“ | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|------|------|----------|
| Agentè¾“å‡ºæ ¼å¼é”™è¯¯ | ä¸­ | é«˜ | ğŸ”´é«˜ | JSON SchemaéªŒè¯ + å›é€€æœºåˆ¶ |
| BOMåŒ¹é…å‡†ç¡®ç‡ä¸‹é™ | ä½ | ä¸­ | ğŸŸ¡ä¸­ | æ¨¡ç³ŠåŒ¹é…ç®—æ³• + å……åˆ†æµ‹è¯• |
| å‰ç«¯æ˜¾ç¤ºå¼‚å¸¸ | ä½ | ä¸­[object Object]| æ•°æ®é€‚é…å™¨ + å…¼å®¹æ€§æµ‹è¯• |
| æ€§èƒ½ä¸å¦‚é¢„æœŸ | ä½ | ä½ | ğŸŸ¢ä½ | æ€§èƒ½ç›‘æ§ + ä¼˜åŒ– |
| æ—§æ•°æ®ä¸å…¼å®¹ | æä½ | é«˜ | ğŸŸ¡ä¸­ | å‰ç«¯é€‚é…å™¨ + ç‰ˆæœ¬æ ‡è®° |

### 5.2 è¯¦ç»†é£é™©åˆ†æ

#### é£é™©1: Agentè¾“å‡ºæ ¼å¼é”™è¯¯
**æè¿°ï¼š** æ–°çš„AssemblyAgentå¯èƒ½è¾“å‡ºä¸ç¬¦åˆé¢„æœŸçš„JSONæ ¼å¼

**ç¼“è§£æªæ–½ï¼š**
1. ä½¿ç”¨JSON Schemaä¸¥æ ¼éªŒè¯è¾“å‡º
2. æ·»åŠ æ ¼å¼æ£€æŸ¥å’Œä¿®å¤é€»è¾‘
3. ä¿ç•™æ—§Agentä»£ç ï¼Œå¯å¿«é€Ÿåˆ‡æ¢
4. å……åˆ†çš„å•å…ƒæµ‹è¯•

**å›é€€æ–¹æ¡ˆï¼š**
```python
try:
    result = await new_assembly_agent.generate(...)
    validate_json_schema(result)
except Exception as e:
    logger.error(f"æ–°Agentå¤±è´¥: {e}, å›é€€åˆ°æ—§Agent")
    result = await old_assembly_agent.generate(...)
```

---

#### é£é™©2: BOMåŒ¹é…å‡†ç¡®ç‡ä¸‹é™
**æè¿°ï¼š** æ‰å¹³åŒ¹é…å¯èƒ½ä¸å¦‚å±‚çº§åŒ¹é…å‡†ç¡®

**ç¼“è§£æªæ–½ï¼š**
1. å¢å¼ºç›¸ä¼¼åº¦ç®—æ³•ï¼ˆdifflib + è‡ªå®šä¹‰è§„åˆ™ï¼‰
2. æ·»åŠ äººå·¥å®¡æ ¸ç•Œé¢ï¼ˆæœªæ¥ï¼‰
3. è®°å½•åŒ¹é…ç½®ä¿¡åº¦ï¼Œä½äºé˜ˆå€¼æ—¶å‘Šè­¦
4. å……åˆ†çš„æµ‹è¯•æ•°æ®è¦†ç›–

**ç›‘æ§æŒ‡æ ‡ï¼š**
```python
# è®°å½•åŒ¹é…ç»Ÿè®¡
match_stats = {
    "total_bom_items": len(bom_items),
    "matched_items": len([m for m in matched if m['match_confidence'] > 0.8]),
    "unmatched_items": len([m for m in matched if m['match_confidence'] == 0]),
    "average_confidence": sum(m['match_confidence'] for m in matched) / len(matched)
}
```

---

#### é£é™©3: å‰ç«¯æ˜¾ç¤ºå¼‚å¸¸
**æè¿°ï¼š** æ–°æ•°æ®ç»“æ„å¯¼è‡´å‰ç«¯æ¸²æŸ“é”™è¯¯

**ç¼“è§£æªæ–½ï¼š**
1. æ•°æ®é€‚é…å™¨å…¼å®¹æ—§æ ¼å¼
2. ç‰ˆæœ¬æ ‡è®°åŒºåˆ†æ•°æ®æ ¼å¼
3. å……åˆ†çš„UIæµ‹è¯•
4. é”™è¯¯è¾¹ç•Œæ•è·å¼‚å¸¸

**å…¼å®¹æ€§ä¿è¯ï¼š**
```typescript
// é”™è¯¯è¾¹ç•Œ
class ManualViewerErrorBoundary extends React.Component {
  componentDidCatch(error, errorInfo) {
    console.error("ManualVieweræ¸²æŸ“é”™è¯¯:", error, errorInfo);
    // é™çº§åˆ°ç®€å•è§†å›¾
    this.setState({ hasError: true });
  }
  
  render() {
    if (this.state.hasError) {
      return <SimpleManualView data={this.props.manualData} />;
    }
    return this.props.children;
  }
}
```

---

### 5.3 å›é€€ç­–ç•¥

#### é…ç½®å¼€å…³å›é€€
```python
# .env
USE_NEW_PIPELINE=false  # åˆ‡æ¢å›æ—§æµç¨‹
```

#### ä»£ç çº§å›é€€
```python
# core/gemini_pipeline.py
class GeminiPipeline:
    async def generate_manual(self, task_id: str) -> Dict:
        use_new = os.getenv("USE_NEW_PIPELINE", "true") == "true"
        
        if use_new:
            try:
                return await self._generate_manual_v2(task_id)
            except Exception as e:
                logger.error(f"æ–°æµç¨‹å¤±è´¥: {e}, å›é€€åˆ°æ—§æµç¨‹")
                return await self._generate_manual_v1(task_id)
        else:
            return await self._generate_manual_v1(task_id)
```

#### æ•°æ®åº“å›é€€
- ä¸éœ€è¦æ•°æ®åº“è¿ç§»
- æ—§æ•°æ®ä¿æŒä¸å˜
- æ–°æ•°æ®é€šè¿‡å‰ç«¯é€‚é…å™¨å…¼å®¹

---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \  E2Eæµ‹è¯• (5%)
      /----\
     /      \ é›†æˆæµ‹è¯• (25%)
    /--------\
   /          \ å•å…ƒæµ‹è¯• (70%)
  /____________\
```

### 6.2 å•å…ƒæµ‹è¯•

#### 6.2.1 FileHandleræµ‹è¯•
**æ–‡ä»¶ï¼š** `tests/test_file_handler.py`

```python
import pytest
from core.file_handler import FileHandler

class TestFileHandler:
    def test_get_files_success(self):
        """æµ‹è¯•æ­£å¸¸è·å–æ–‡ä»¶"""
        handler = FileHandler("test_task_001")
        files = handler.get_files()
        
        assert files['pdf_file'].endswith('.pdf')
        assert files['step_file'] is not None
        assert len(files['images']) > 0
    
    def test_extract_step_parts_from_file(self):
        """æµ‹è¯•ä»å•ä¸ªSTEPæ–‡ä»¶æå–é›¶ä»¶"""
        handler = FileHandler("test_task_001")
        parts = handler.extract_step_parts("test.step")
        
        assert len(parts) > 0
        assert all(p.endswith('.step') for p in parts)
    
    def test_extract_step_parts_from_folder(self):
        """æµ‹è¯•ä»STEPæ–‡ä»¶å¤¹æå–é›¶ä»¶"""
        handler = FileHandler("test_task_002")
        parts = handler.extract_step_parts("step_folder/")
        
        assert len(parts) > 0
        assert all(p.endswith('.step') for p in parts)
    
    def test_missing_pdf_raises_error(self):
        """æµ‹è¯•ç¼ºå°‘PDFæ—¶æŠ›å‡ºå¼‚å¸¸"""
        handler = FileHandler("empty_task")
        
        with pytest.raises(FileNotFoundError):
            handler.get_files()
```

#### 6.2.2 BOMMatcheræµ‹è¯•
**æ–‡ä»¶ï¼š** `tests/test_bom_matcher.py`

```python
import pytest
from core.bom_matcher import FlatBOMMatcher

class TestBOMMatcher:
    def test_exact_match(self):
        """æµ‹è¯•ç²¾ç¡®åŒ¹é…"""
        matcher = FlatBOMMatcher()
        bom_items = [{"name": "åº•æ¿", "quantity": 1}]
        step_files = ["åº•æ¿.step"]
        
        result = matcher.match(bom_items, step_files)
        
        assert len(result) == 1
        assert result[0]['matched_file'] == "åº•æ¿.step"
        assert result[0]['match_confidence'] == 1.0
    
    def test_fuzzy_match(self):
        """æµ‹è¯•æ¨¡ç³ŠåŒ¹é…"""
        matcher = FlatBOMMatcher()
        bom_items = [{"name": "å·¦æŒ‚ä»¶", "quantity": 1}]
        step_files = ["å·¦ä¾§æŒ‚ä»¶.step"]
        
        result = matcher.match(bom_items, step_files)
        
        assert len(result) == 1
        assert result[0]['matched_file'] == "å·¦ä¾§æŒ‚ä»¶.step"
        assert result[0]['match_confidence'] > 0.7
    
    def test_unmatched_bom(self):
        """æµ‹è¯•BOMä¸­æœ‰ä½†STEPä¸­æ²¡æœ‰çš„é›¶ä»¶"""
        matcher = FlatBOMMatcher()
        bom_items = [{"name": "èºæ “", "quantity": 10}]
        step_files = ["åº•æ¿.step"]
        
        result = matcher.match(bom_items, step_files)
        
        assert len(result) == 1
        assert result[0]['matched_file'] is None
        assert result[0]['match_confidence'] == 0.0
    
    def test_quantity_mismatch_warning(self):
        """æµ‹è¯•æ•°é‡ä¸åŒ¹é…æ—¶çš„è­¦å‘Š"""
        matcher = FlatBOMMatcher()
        bom_items = [{"name": "èºæ “", "quantity": 10}]
        step_files = ["èºæ “.step"]  # åªæœ‰1ä¸ªæ–‡ä»¶
        
        result = matcher.match(bom_items, step_files)
        
        # åº”è¯¥æœ‰è­¦å‘Šæ—¥å¿—
        assert result[0]['quantity_mismatch'] == True
```

#### 6.2.3 AssemblyAgentæµ‹è¯•
**æ–‡ä»¶ï¼š** `tests/test_assembly_agent.py`

```python
import pytest
from prompts.agent_assembly import AssemblyAgent

class TestAssemblyAgent:
    @pytest.mark.asyncio
    async def test_generate_steps_success(self):
        """æµ‹è¯•æˆåŠŸç”Ÿæˆè£…é…æ­¥éª¤"""
        agent = AssemblyAgent()
        
        bom_items = [
            {"name": "åº•æ¿", "quantity": 1, "material": "Q235"},
            {"name": "å·¦æŒ‚ä»¶", "quantity": 1, "material": "Q235"}
        ]
        step_parts = ["åº•æ¿.step", "å·¦æŒ‚ä»¶.step"]
        images = ["base64_image_1", "base64_image_2"]
        
        result = await agent.generate(bom_items, step_parts, images)
        
        assert 'assembly_steps' in result
        assert len(result['assembly_steps']) > 0
        assert result['assembly_steps'][0]['step_id'] == "step_1"
        assert 'description' in result['assembly_steps'][0]
        assert 'parts' in result['assembly_steps'][0]
    
    @pytest.mark.asyncio
    async def test_output_format_validation(self):
        """æµ‹è¯•è¾“å‡ºæ ¼å¼éªŒè¯"""
        agent = AssemblyAgent()
        
        # ... è°ƒç”¨agent
        
        result = await agent.generate(...)
        
        # éªŒè¯JSON Schema
        from jsonschema import validate
        schema = {...}  # å®šä¹‰Schema
        validate(instance=result, schema=schema)
```

---

### 6.3 é›†æˆæµ‹è¯•

#### 6.3.1 Pipelineé›†æˆæµ‹è¯•
**æ–‡ä»¶ï¼š** `tests/test_pipeline_new.py`

```python
import pytest
from core.gemini_pipeline import GeminiPipeline

class TestPipelineIntegration:
    @pytest.mark.asyncio
    async def test_full_pipeline_with_real_data(self):
        """æµ‹è¯•å®Œæ•´æµç¨‹ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰"""
        pipeline = GeminiPipeline()
        
        # ä½¿ç”¨æµ‹è¯•ä»»åŠ¡
        task_id = "test_task_hanger_assembly"
        
        result = await pipeline.generate_manual(task_id)
        
        # éªŒè¯è¾“å‡ºç»“æ„
        assert result['version'] == "2.0"
        assert 'product_name' in result
        assert 'assembly_steps' in result
        assert len(result['assembly_steps']) > 0
        assert 'welding' in result
        assert 'safety' in result
        assert 'bom' in result
        
        # éªŒè¯æ€§èƒ½
        assert result['metadata']['performance']['total_time'] < 60  # å°äº60ç§’
    
    @pytest.mark.asyncio
    async def test_pipeline_performance_comparison(self):
        """æµ‹è¯•æ–°æ—§æµç¨‹æ€§èƒ½å¯¹æ¯”"""
        pipeline = GeminiPipeline()
        task_id = "test_task_hanger_assembly"
        
        # æµ‹è¯•æ—§æµç¨‹
        import time
        start = time.time()
        old_result = await pipeline._generate_manual_v1(task_id)
        old_time = time.time() - start
        
        # æµ‹è¯•æ–°æµç¨‹
        start = time.time()
        new_result = await pipeline._generate_manual_v2(task_id)
        new_time = time.time() - start
        
        # æ–°æµç¨‹åº”è¯¥æ›´å¿«
        assert new_time < old_time
        print(f"æ€§èƒ½æå‡: {(old_time - new_time) / old_time * 100:.1f}%")
```

---

### 6.4 E2Eæµ‹è¯•

#### 6.4.1 å‰ç«¯E2Eæµ‹è¯•
**æ–‡ä»¶ï¼š** `frontend/tests/e2e/manual_viewer.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('ManualViewer', () => {
  test('should display v2.0 manual correctly', async ({ page }) => {
    // åŠ è½½æµ‹è¯•æ•°æ®
    await page.goto('/manual/test_task_v2');
    
    // éªŒè¯æ ‡é¢˜
    await expect(page.locator('h1')).toContainText('æŒ‚ä»¶æ€»æˆ');
    
    // éªŒè¯è£…é…æ­¥éª¤
    const steps = page.locator('.assembly-step');
    await expect(steps).toHaveCount(5);  // å‡è®¾æœ‰5ä¸ªæ­¥éª¤
    
    // éªŒè¯ç¬¬ä¸€ä¸ªæ­¥éª¤
    const firstStep = steps.first();
    await expect(firstStep).toContainText('å®‰è£…åº•æ¿');
    await expect(firstStep).toContainText('åº•æ¿');
    
    // éªŒè¯BOMè¡¨
    await expect(page.locator('.bom-table')).toBeVisible();
  });
  
  test('should handle v1.0 manual with adapter', async ({ page }) => {
    // åŠ è½½æ—§ç‰ˆæœ¬æ•°æ®
    await page.goto('/manual/test_task_v1');
    
    // åº”è¯¥ä»ç„¶èƒ½æ­£å¸¸æ˜¾ç¤º
    await expect(page.locator('h1')).toBeVisible();
    await expect(page.locator('.assembly-step')).toHaveCount.greaterThan(0);
  });
});
```

---
