# 完整版本历史

**项目**: Mecagent  
**最后更新**: 2025-11-13

---

## v1.1.6 (2025-11-13) - 修复焊接模块组件名称同步问题

### 🐛 Bug 修复

**问题描述**:
- 修改焊接模块的组件名称无法同步到 `component_name`
- 安全警告模块可以同步，但焊接模块不行
- 导致前端显示的组件名称与编辑的不一致

**根本原因**:
保存时执行顺序导致数据覆盖：
1. 焊接模块先更新 `component.component_name = updatedComponentName`（新值 ✅）
2. 安全警告模块后更新 `component.component_name = updatedComponentNameFromSafety`（旧值 ❌）
3. 因为用户只修改了焊接模块的组件名称，安全警告模块的 `warning.component` 还是旧值
4. 导致安全警告模块用旧值覆盖了焊接模块的更新

**修复方案**:
采用**实时同步**方案：
1. 添加 `watch` 监听焊接模块的组件名称变化
2. 自动同步到安全警告模块的所有警告
3. 安全警告模块的组件名称设为只读（灰色背景）
4. 焊接模块增加醒目的警告提示（橙色 + 图标）

### 📝 修改文件

**frontend/src/views/ManualViewer.vue**:

1. **第383-392行**: 焊接模块组件名称提示增强
   ```vue
   <el-text type="warning" size="small">
     <el-icon><Warning /></el-icon>
     修改组件名称会同步更新到当前步骤和安全警告模块
   </el-text>
   ```

2. **第484-494行**: 安全警告模块组件名称设为只读
   ```vue
   <el-input
     v-model="warning.component"
     disabled
     style="background-color: #f5f7fa;"
   />
   <el-text type="info" size="small">
     组件名称由焊接模块自动同步，不可单独修改
   </el-text>
   ```

3. **第587-592行**: 导入 Warning 图标
   ```javascript
   import { Warning } from '@element-plus/icons-vue'
   ```

4. **第1206-1220行**: 添加 watch 监听逻辑
   ```javascript
   watch(
     () => editData.value.welding_requirements.length > 0
       ? editData.value.welding_requirements[0].component
       : null,
     (newComponentName) => {
       if (newComponentName && editData.value.safety_warnings.length > 0) {
         editData.value.safety_warnings.forEach(warning => {
           warning.component = newComponentName
         })
         console.log('🔄 [组件名称同步] 焊接模块 → 安全警告模块:', newComponentName)
       }
     }
   )
   ```

### 🎯 用户体验提升

- ✅ 视觉提示: 焊接模块有醒目的橙色警告提示
- ✅ 自动同步: 修改焊接模块时，安全警告模块实时同步
- ✅ 防止混淆: 安全警告模块的组件名称设为只读（灰色）
- ✅ 调试友好: 控制台会输出同步日志

### ⚠️ 注意事项

1. **只读限制**: 现在只能通过焊接模块修改组件名称，安全警告模块是只读的
2. **同步条件**: 只有当焊接模块有数据时才会触发同步
3. **多个警告**: 如果一个步骤有多个安全警告，所有警告的组件名称都会同步更新

---

## v1.1.5 (2025-11-10) - 支持组件名称修改

### ✨ 新功能

1. **组件名称编辑**
   - ✅ 支持修改组件名称
   - ✅ 使用唯一 `step_id` 精确匹配，避免误更新
   - ✅ 修改后实时同步到前端显示
   - ✅ 自动保存到后端 JSON 文件

2. **焊接要求管理**
   - ✅ 添加/删除焊接要求
   - ✅ 编辑焊接类型、焊缝尺寸、焊接位置
   - ⚠️ 限制每个步骤只能添加一个焊接要求

3. **安全警告管理**
   - ✅ 添加/删除安全警告
   - ✅ 编辑警告内容

4. **数据持久化**
   - ✅ 所有编辑内容自动保存到 `output/{task_id}/assembly_manual.json`
   - ✅ 自动递增版本号（格式：`major.minor`）
   - ✅ 添加 `lastUpdated` 时间戳
   - ✅ 支持刷新页面后数据保持

### 🐛 Bug 修复

1. **组件名称更新问题**
   - **问题**: 修改组件名称后，前端显示没有更新
   - **原因**: 前端显示的是 `component.component_name`（组件级别），但代码只更新了 `step.component_name`（步骤级别）
   - **修复**: 同时更新组件级别和步骤级别的 `component_name`

2. **焊接要求添加问题**
   - **问题**: 添加第二个焊接要求后无法保存
   - **原因**: 后端数据结构 `step.welding` 是单个对象，不支持数组
   - **修复**: 限制每个步骤只能添加一个焊接要求，并在 UI 上提示用户

3. **质检显示问题**
   - **问题**: 质检标签页显示了所有步骤的质检要求
   - **原因**: 计算属性返回了所有步骤的质检
   - **修复**: 新增 `currentStepQualityCheck` 计算属性，只返回当前步骤的质检

### 📝 修改文件

**frontend/src/views/ManualViewer.vue**:
- 第1277-1340行: 焊接模块保存逻辑（更新组件名称）
- 第1342-1382行: 安全警告模块保存逻辑（更新组件名称）

---

## v1.1.4 (2025-11-10) - 修复组件步骤过滤BUG

### 🐛 严重BUG修复（组件步骤数据混乱问题）

**严重级别**: 🔴 严重（会导致数据显示错误和混乱）

**问题描述**:
1. 编辑页面显示有内容（可以看到编辑器里有数据）
2. 但前端页面没有渲染这些内容（页面显示为空或显示其他内容）
3. 不同组件的相同步骤号数据混在一起显示
4. 例如：主框架组件的步骤1 显示了 挂架组件的步骤1 的焊接数据

**根本原因**:
- 每个组件都有独立的步骤序列（例如：主框架组件有步骤1-13，挂架组件有步骤1-7）
- v1.1.3 的修复中，为了解决"编辑后数据不显示"的问题，把过滤逻辑改为只按步骤号过滤
- 这导致不同组件的相同步骤号数据混乱
- 用户可以手动修改组件名称，导致数据不一致

**解决方案**:
1. **恢复双重过滤逻辑**: 必须同时匹配 `step_number` 和 `component`
2. **编辑对话框中组件名称设为只读**: 步骤号和组件名称都由系统自动确定
3. **添加数据时自动填充正确的组件名称**: 使用 `currentStep.component_name` 而不是 `currentStep.action`
4. **保存时强制使用当前步骤的组件名称**: 避免用户手动修改导致的数据不一致

### 📝 修改文件

**frontend/src/views/ManualViewer.vue**:
- 第957-996行: 恢复焊接数据双重过滤逻辑
- 第400-422行: 焊接数据编辑表单 - 组件名称设为只读
- 第501-524行: 安全警告编辑表单 - 组件名称设为只读
- 第1183-1220行: 修复添加函数使用正确的字段
- 第1252-1287行: 保存焊接数据时强制使用正确的值

---

## v1.1.3 及更早版本

详细历史请参考项目根目录下的 `RELEASE_v*.md` 文件。

---

## 🔄 版本号规则

- **主版本号（major）**: 重大功能更新或架构变更
- **次版本号（minor）**: 新功能添加或重要 Bug 修复
- **修订号（patch）**: 小 Bug 修复或文档更新

---

## 📞 问题反馈

如果遇到问题，请在 GitHub 上提交 Issue。

