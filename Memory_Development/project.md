# Mecagent 项目快照

**项目类型**: 小型项目
**当前版本**: v1.5.0（内部开发版本）/ v1.1.7（GitHub发布版本）
**最后更新**: 2025-11-14
**GitHub**: https://github.com/xiaotang-12-ops/yilite

> **版本号说明**：
> - **内部开发版本**（changelog.md）：v1.5.0 - 用于记录详细的开发历史和功能迭代
> - **GitHub发布版本**（对外发布）：v1.1.7 - 用于对外发布的稳定版本号

---

## 📁 项目结构

```
Mecagent/
├── frontend/              # Vue3 前端
│   ├── src/
│   │   ├── views/        # 页面组件
│   │   │   └── ManualViewer.vue  # 装配说明书查看器（核心页面）
│   │   └── components/   # 通用组件
│   └── public/           # 静态资源
├── backend/              # 后端服务
├── agents/               # AI Agent 模块
│   ├── vision_planning_agent.py      # Agent 1: 视觉规划
│   ├── component_assembly_agent.py   # Agent 3: 组件装配
│   ├── product_assembly_agent.py     # Agent 4: 产品装配
│   ├── welding_agent.py              # Agent 5: 焊接工艺
│   └── safety_faq_agent.py           # Agent 6: 安全FAQ
├── core/                 # 核心处理模块
│   ├── gemini_pipeline.py           # Gemini 处理流水线
│   ├── ai_matcher.py                # AI 匹配器
│   └── manual_integrator_v2.py      # 说明书集成器
├── api.py                # FastAPI 主入口
├── output/               # 生成的装配说明书输出
└── docs/                 # 文档
```

---

## 🔌 API 清单

| 端点 | 方法 | 功能 | 参数 |
|------|------|------|------|
| `/api/upload` | POST | 上传文件（PDF/STEP） | `files: List[UploadFile]` |
| `/api/generate` | POST | 生成装配说明书 | `task_id: str` |
| `/output/{path}` | GET | 获取输出文件 | `path: str` |
| `/api/health` | GET | 健康检查 | 无 |

---

## 🎯 功能概览

### 核心功能
1. **文件上传**: 支持 PDF（图纸）和 STEP（3D模型）文件上传
2. **AI 处理流水线**: 
   - Agent 1: 视觉分析（Qwen-VL）
   - Agent 2: BOM-3D 匹配（DeepSeek）
   - Agent 3: 组件装配规划（Gemini）
   - Agent 4: 产品装配规划（Gemini）
   - Agent 5: 焊接工艺分析（Gemini）
   - Agent 6: 安全警告和FAQ（Gemini）
3. **装配说明书生成**: 生成 JSON 格式的装配说明书
4. **前端查看器**: 
   - 3D 模型展示（Three.js）
   - 步骤导航
   - 焊接要求、安全警告、质检、FAQ 展示
   - **管理员编辑功能**（v1.1.5+）

### 管理员编辑功能（重要）
- 登录验证（用户名/密码）
- 编辑当前步骤的：
  - 焊接要求
  - 安全警告
  - 质检要求
  - FAQ
  - **组件名称**（v1.1.6+）
- 实时保存到 JSON 文件
- 自动版本号递增

---

## 📝 最近3个版本

### v1.6.0 (2025-11-14) - 支持步骤描述编辑功能 ⭐

**新功能**:
- ✅ 管理员可以编辑装配步骤的描述（`description` 字段）
- ✅ 编辑对话框默认显示"步骤描述"标签页
- ✅ 支持最多500字符的描述文本
- ✅ 实时字符计数和提示信息
- ✅ 保存后立即同步到前端显示和后端JSON文件

**修改文件**:
- `frontend/src/views/ManualViewer.vue`
  - 第638行: 修改默认标签页为 'description'
  - 第647行: 在 editData 中添加 description 字段
  - 第1206行: 在数据加载逻辑中添加 description 的加载
  - 第1453-1485行: 在保存逻辑中添加 description 的保存（约30行代码）
  - 第324-356行: 添加"步骤描述"标签页UI（约30行代码）

**技术细节**:
- 使用 `step_id` 精确匹配步骤，确保修改正确的步骤
- 同时支持组件装配步骤和产品装配步骤
- 文本框高度10行，字符限制500字符
- 向后兼容：如果步骤没有 description，显示空字符串

**用户体验**:
- 打开编辑对话框，直接看到步骤描述编辑框
- 文本框足够大，方便编辑长文本
- 实时显示字符计数，避免超出限制
- 有提示信息说明描述的用途

---

### v1.5.0 (2025-11-15) - 产品装配重复组件检测与修正

**问题背景**:
- AI生成的产品装配步骤中，步骤3和步骤4重复安装了步骤1中已经放置的子组件
- 导致3D高亮错误：步骤17和步骤18高亮了子组件内部的零件

**解决方案**:
1. **强化提示词**：明确说明步骤1的组件不需要再次安装，添加错误示例和正确示例
2. **后端验证**：自动检测并删除重复的组件安装步骤，重新编号

**修改文件**:
- `prompts/agent_4_product_assembly.py`（第64-112行）
  - 添加"特别注意"部分，解释为什么AI会出错
  - 添加错误示例和正确示例
- `agents/product_assembly_agent.py`（第334-423行）
  - 在`_auto_generate_3d_highlight`方法中添加检测逻辑
  - 自动删除重复的组件安装步骤

**预期效果**:
- ✅ 产品装配步骤只包含产品级别的零件（螺栓、刀板、销轴、轴承等）
- ✅ 不会重复安装步骤1中已经放置的子组件
- ✅ 3D高亮正确（黄色只高亮当前步骤的零件）

---

### v1.4.0 (2025-11-15) - 用户修改描述字段不影响3D高亮

**问题背景**:
- 管理员模式允许用户修改步骤的`description`字段
- 前端会同时从`parts_used`和`description`中提取BOM序号来高亮零件
- 如果用户修改`description`，改变了BOM序号，会导致3D高亮错误

**解决方案**:
- 修改前端逻辑：只有当`parts_used`为空时，才从`description`中提取BOM序号（作为备用方案）

**修改文件**:
- `frontend/src/views/ManualViewer.vue`（第829-839行）

**预期效果**:
- ✅ 用户可以随意修改`description`字段，不会影响3D高亮
- ✅ 向后兼容：如果旧数据中`parts_used`为空，仍然可以从`description`中提取BOM序号

---

### v1.3.1 (2025-11-14) - 产品装配3D高亮验证与修正

**新功能**:
1. 添加`3d_highlight`字段，明确指定每个步骤应该高亮的零件
2. 修复焊接场景下零件颜色冲突问题（参照零件被错误高亮为黄色）
3. 优化Agent 3提示词，要求生成3d_highlight字段
4. 强制"每步一个新BOM项"规则（焊接场景）
5. **修复点焊/满焊步骤的parts_used为空问题**
6. 添加parts_used不为空的验证逻辑

**核心规则**:
- **每个步骤只能引入1个新的BOM项**（不是1个实例）
- **如果BOM有N项，应该生成N个安装步骤**（不包括点焊/满焊）
- **一个BOM项可以有多个实例**（如2个侧板），这些实例在同一个步骤中安装
- **3d_highlight包含该BOM项的所有实例的node_name**

**技术改进**:
1. Agent 3提示词添加"3D高亮规则"章节
2. `component_assembly_agent.py`添加3d_highlight自动生成逻辑
3. 前端三色逻辑优先使用3d_highlight字段
4. 添加焊接/装配场景区分机制
5. 添加步骤数量验证逻辑

**修改文件**:
- `prompts/agent_3_component_assembly.py`
  - 第117-127行: 修改分组装配步骤规则（焊接场景每步一个新零件）
  - 第192-240行: 添加3D高亮规则章节
  - 第266-284行: JSON输出格式添加3d_highlight字段
  - 第480-495行: 添加3D高亮要求
  - 第505-519行: 添加3D高亮自检清单
  - 第538-548行: JSON模板添加3d_highlight字段
- `agents/component_assembly_agent.py`
  - 第132-146行: 添加3d_highlight验证逻辑
  - 第273-323行: 添加3d_highlight自动生成逻辑

**数据结构变化**:
- 每个装配步骤新增`3d_highlight`字段（字符串数组）
- 示例：
  ```json
  {
    "step_number": 2,
    "action": "安装侧板",
    "parts_used": [
      {"bom_seq": "1", "bom_name": "方形板-机加", "node_name": ["NAUO1"]},
      {"bom_seq": "2", "bom_name": "侧板", "quantity": 2, "node_name": ["NAUO3", "NAUO2"]}
    ],
    "3d_highlight": ["NAUO3", "NAUO2"]  // 包含该BOM项的所有实例
  }
  ```

**预期效果**:
- 🟢 绿色：已焊接的零件（前面步骤的零件）
- 🟡 黄色：正在焊接的零件（3d_highlight中的零件，包含该BOM项的所有实例）
- ⚪ 灰色：未焊接的零件

---

### v1.1.5 (2025-11-10) - 支持组件名称修改

**新功能**:
1. 支持修改组件名称
2. 使用唯一 `step_id` 精确匹配，避免误更新
3. 修改后实时同步到前端显示
4. 自动保存到后端 JSON 文件

**Bug 修复**:
1. **组件名称更新问题**
   - 问题: 修改组件名称后，前端显示没有更新
   - 原因: 前端显示的是 `component.component_name`（组件级别），但代码只更新了 `step.component_name`（步骤级别）
   - 修复: 同时更新组件级别和步骤级别的 `component_name`

2. **焊接要求添加问题**
   - 问题: 添加第二个焊接要求后无法保存
   - 原因: 后端数据结构 `step.welding` 是单个对象，不支持数组
   - 修复: 限制每个步骤只能添加一个焊接要求

3. **质检显示问题**
   - 问题: 质检标签页显示了所有步骤的质检要求
   - 修复: 新增 `currentStepQualityCheck` 计算属性，只返回当前步骤的质检

**修改文件**:
- `frontend/src/views/ManualViewer.vue`
  - 第1277-1340行: 焊接模块保存逻辑（更新组件名称）
  - 第1342-1382行: 安全警告模块保存逻辑（更新组件名称）

---

### v1.1.4 (2025-11-10) - 修复组件步骤过滤BUG

**严重BUG修复**:
- 问题: 不同组件的相同步骤号数据混在一起显示
- 原因: 过滤逻辑只按步骤号过滤，没有同时匹配组件名称
- 修复: 恢复双重过滤逻辑（`step_number` + `component`）

**修改**:
1. 恢复焊接数据双重过滤逻辑
2. 恢复安全警告双重过滤逻辑
3. 编辑对话框中组件名称设为只读（当时的方案，v1.1.5 改为可编辑）
4. 添加数据时自动填充正确的组件名称
5. 保存时强制使用当前步骤的组件名称

**修改文件**:
- `frontend/src/views/ManualViewer.vue`
  - 第957-996行: 恢复焊接数据双重过滤逻辑
  - 第400-422行: 焊接数据编辑表单 - 组件名称设为只读
  - 第501-524行: 安全警告编辑表单 - 组件名称设为只读
  - 第1183-1220行: 修复添加函数使用正确的字段
  - 第1252-1287行: 保存焊接数据时强制使用正确的值

---

## 🔍 关键技术点

### 前端技术栈
- Vue 3 + TypeScript
- Element Plus UI 组件库
- Three.js（3D 模型渲染）
- Axios（HTTP 请求）

### 后端技术栈
- FastAPI（Python Web 框架）
- Gemini API（Google AI）
- Qwen-VL（视觉分析）
- DeepSeek（BOM 匹配）

### 数据结构
- 装配说明书: JSON 格式
- 步骤数据: 包含 `step_id`（唯一标识）、`step_number`、`component_name`
- 焊接数据: 步骤内嵌字段 `step.welding`（单个对象）
- 安全警告: 步骤内嵌字段 `step.safety_warnings`（字符串数组）

---

## ⚠️ 重要注意事项

1. **组件名称同步**: 
   - v1.1.6 开始，焊接模块的组件名称会自动同步到安全警告模块
   - 安全警告模块的组件名称是只读的，只能通过焊接模块修改

2. **步骤唯一标识**: 
   - 使用 `step_id` 作为唯一标识，避免步骤号重复导致的数据混乱
   - 不同组件可以有相同的步骤号，但 `step_id` 必须唯一

3. **焊接要求限制**: 
   - 每个步骤只能添加一个焊接要求（后端数据结构限制）

4. **Docker 部署**: 
   - 前后端都基于 Docker 运行
   - 不要直接用 `npm run dev` 启动，应该使用 Docker 命令

---

## 📚 相关文档

- 详细 API 文档: 见 `Memory_Development/api.md`
- 完整版本历史: 见 `Memory_Development/changelog.md`

---

## 📝 最近3个版本更新

### v1.1.7 (2025-01-14) - 三色高亮显示系统

**核心功能**:
- ✅ 三色高亮显示系统
  - 🟡 黄色：当前步骤正在装配的零件
  - 🟢 绿色：已完成装配的零件
  - ⚪ 灰色：尚未装配的零件
- ✅ 单零件步骤优化：每个装配步骤只涉及一个零件
- ✅ 智能高亮计算：自动识别新零件，避免重复高亮

**技术实现**:
- 前端高亮逻辑：`highlightStepParts()` (ManualViewer.vue 第2042行)
- 已装配零件计算：`assembledMeshes` 计算属性（第945行）
- 后端3D高亮生成：组件装配Agent自动生成`3d_highlight`字段

**视觉优化**:
- 高对比度材质设计，适合车间环境
- 发光效果（emissive）增强零件识别度
- 天蓝色基础材质（`0x4A90E2`），清晰锐利

**Bug修复**:
- 修复组件切换时高亮状态不更新
- 修复首次加载时已装配零件计算错误
- 优化GLB模型切换逻辑

**待开发功能**:
- ⏳ 颜色自定义：允许用户自定义三种状态的颜色
- ⏳ 描述编辑：支持在线编辑装配步骤描述

---

### v1.1.6 (2025-01-13)

**Bug修复**:
- 修复前端数据加载问题
- 优化WebSocket连接稳定性

---

### v1.1.5 (2025-01-12)

**新增功能**:
- ✅ 管理员登录功能
- ✅ 在线编辑焊接要求、安全警告、质检要求
- ✅ 组件名称修改并实时同步
- ✅ 数据持久化保存

