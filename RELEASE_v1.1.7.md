# 🎉 Release v1.1.7 - 三色高亮显示系统

**发布日期**: 2025-01-14

---

## 📋 版本概述

v1.1.7 版本引入了全新的**三色高亮显示系统**，通过不同颜色直观展示零件的装配状态，大幅提升了装配说明书的可读性和工人的操作效率。

---

## ✨ 核心新功能

### 🎨 三色高亮显示系统

在3D模型查看器中，零件根据装配状态显示不同颜色：

| 颜色 | 状态 | 说明 | 视觉效果 |
|------|------|------|----------|
| 🟡 **黄色** | 正在装配 | 当前步骤需要操作的零件 | 高亮发光，醒目突出 |
| 🟢 **绿色** | 已装配 | 前面步骤已完成的零件 | 柔和发光，表示完成 |
| ⚪ **灰色** | 未装配 | 后续步骤才会用到的零件 | 半透明，低调显示 |

**技术参数**：
- 黄色：`color: 0xffff00`, `emissive: 0xffaa00`, `emissiveIntensity: 0.8`
- 绿色：`color: 0x4CAF50`, `emissive: 0x2E7D32`, `emissiveIntensity: 0.3`
- 灰色：`color: 0x808080`, `opacity: 0.3`, `transparent: true`

### 📐 单零件步骤优化

**改进前**：
```
步骤2：将侧板焊接到底板上
  涉及零件：底板（参照）、侧板（新零件）
  问题：两个零件都高亮，工人不清楚要操作哪个
```

**改进后**：
```
步骤2：将侧板焊接到底板上
  黄色高亮：侧板（新零件，需要操作）
  绿色显示：底板（已装配，作为参照）
  灰色显示：其他零件（未装配）
```

**智能识别算法**：
```python
# 自动计算新零件
新零件 = 当前步骤的零件 - 前面所有步骤的零件

# 只高亮新零件
3d_highlight = [新零件的node_name]
```

### 🔧 技术实现细节

#### 前端高亮逻辑
- **核心函数**: `highlightStepParts()` (ManualViewer.vue 第2042行)
- **已装配计算**: `assembledMeshes` 计算属性（第945行）
- **优先级规则**: 黄色 > 绿色 > 灰色

#### 后端数据生成
- **组件装配Agent**: 自动生成`3d_highlight`字段
- **产品装配Agent**: 自动生成`3d_highlight`字段
- **验证机制**: 强制验证所有步骤的高亮数据

---

## 🎯 用户体验提升

### 工人视角
1. **一眼识别**：黄色零件就是当前要操作的
2. **进度可视**：绿色零件表示已完成，灰色零件表示还没到
3. **减少错误**：不会搞混参照零件和操作零件

### 车间环境适配
- **高对比度**：即使在强光下也清晰可见
- **发光效果**：增强零件边缘识别度
- **颜色区分**：色盲友好的颜色选择

---

## 📊 性能优化

- ✅ 材质缓存：避免重复创建材质对象
- ✅ 智能更新：只在步骤切换时重新计算高亮
- ✅ 节点名称规范化：兼容`mesh_xxx`和`NAUOxxx`格式

---

## 🐛 Bug修复

1. **修复组件切换时高亮状态不更新**
   - 问题：切换组件后，零件颜色没有重置
   - 解决：在`switchGLBModel()`中重新计算高亮

2. **修复首次加载时已装配零件计算错误**
   - 问题：第一步也显示绿色零件
   - 解决：正确处理`currentStepIndex = 0`的情况

3. **优化GLB模型切换逻辑**
   - 问题：频繁切换导致性能下降
   - 解决：只在GLB文件真正变化时才切换

---

## 📝 文档更新

- ✅ 更新README.md，添加v1.1.7功能说明
- ✅ 更新CHANGELOG.md，记录详细变更
- ✅ 创建RELEASE_v1.1.7.md发布说明
- ✅ 更新VERSION文件至1.1.7

---

## 🔍 已知限制

### 当前版本限制
1. **颜色不可自定义**
   - 三种状态的颜色是固定的
   - 计划在v1.1.8支持用户自定义

2. **描述不可编辑**
   - 装配步骤描述暂不支持在线编辑
   - 计划在v1.1.8添加编辑功能

### 建模相关问题
3. **产品总图STEP文件简化问题**
   - 如果产品总图STEP中组件被简化表示（只包含部分零件）
   - 会导致部分零件无法高亮
   - **这是建模问题，不是代码问题**
   - 解决方案：要求建模人员提供完整的产品总图STEP文件

---

## 📦 部署说明

### Docker部署（推荐）

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 重新构建镜像
docker-compose build

# 3. 重启服务
docker-compose down
docker-compose up -d
```

### 本地开发环境

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 更新前端依赖（如有变化）
cd frontend
npm install

# 3. 重启服务
# 后端
python api.py

# 前端
cd frontend
npm run dev
```

---

## 🔄 升级指南

### 从v1.1.6升级

**数据兼容性**：
- ✅ 完全兼容v1.1.6的数据格式
- ✅ 自动为旧数据生成`3d_highlight`字段
- ✅ 无需手动迁移数据

**配置变更**：
- 无配置变更

**API变更**：
- 无API变更

---

## 🎯 下一步计划（v1.1.8）

### 计划新增功能
1. **颜色自定义**
   - 允许用户自定义三种状态的颜色
   - 提供颜色选择器界面
   - 保存用户偏好设置

2. **描述编辑**
   - 支持在线编辑装配步骤描述
   - 实时预览编辑效果
   - 数据持久化保存

3. **高亮动画**
   - 零件高亮时添加过渡动画
   - 提升视觉体验

---

## 🤝 贡献者

感谢所有为本版本做出贡献的开发者！

---

## 📞 反馈与支持

如有问题或建议，请：
- 提交Issue: https://github.com/xiaotang-12-ops/yilite/issues
- 查看文档: https://github.com/xiaotang-12-ops/yilite/wiki

---

## 📄 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

