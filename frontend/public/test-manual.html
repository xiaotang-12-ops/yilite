<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•åŠ è½½è¯´æ˜ä¹¦</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .button-group {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
      background: #409eff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #66b1ff;
    }
    .info {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .success {
      background: #f0f9ff;
      color: #67c23a;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .error {
      background: #fef0f0;
      color: #f56c6c;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
    }
  </style>
</head>
<body>
  <h1>ğŸ“– æµ‹è¯•åŠ è½½è£…é…è¯´æ˜ä¹¦</h1>
  
  <div class="button-group">
    <button onclick="loadFromFile()">1. ä»æ–‡ä»¶åŠ è½½ JSON</button>
    <button onclick="saveToLocalStorage()">2. ä¿å­˜åˆ° localStorage</button>
    <button onclick="viewInManualViewer()">3. åœ¨æŸ¥çœ‹å™¨ä¸­æ‰“å¼€</button>
    <button onclick="clearStorage()">æ¸…ç©ºç¼“å­˜</button>
  </div>

  <div id="status"></div>
  
  <div class="info">
    <h3>ğŸ“ è¯´æ˜ï¼š</h3>
    <ol>
      <li>ç‚¹å‡»"ä»æ–‡ä»¶åŠ è½½ JSON"æŒ‰é’®ï¼Œé€‰æ‹© <code>output/2ca76253-b25e-45b9-9f88-c4c389bf0894/assembly_manual.json</code></li>
      <li>ç‚¹å‡»"ä¿å­˜åˆ° localStorage"å°†æ•°æ®ä¿å­˜åˆ°æµè§ˆå™¨ç¼“å­˜</li>
      <li>ç‚¹å‡»"åœ¨æŸ¥çœ‹å™¨ä¸­æ‰“å¼€"è·³è½¬åˆ°æŸ¥çœ‹å™¨é¡µé¢</li>
    </ol>
  </div>

  <div id="preview"></div>

  <script>
    let manualData = null;

    async function loadFromFile() {
      try {
        // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              manualData = JSON.parse(event.target.result);
              showStatus('success', `âœ… æˆåŠŸåŠ è½½æ–‡ä»¶: ${file.name}`);
              showPreview();
            } catch (error) {
              showStatus('error', `âŒ JSON è§£æå¤±è´¥: ${error.message}`);
            }
          };
          reader.readAsText(file);
        };

        input.click();
      } catch (error) {
        showStatus('error', `âŒ åŠ è½½å¤±è´¥: ${error.message}`);
      }
    }

    function saveToLocalStorage() {
      if (!manualData) {
        showStatus('error', 'âŒ è¯·å…ˆåŠ è½½ JSON æ–‡ä»¶');
        return;
      }

      try {
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('current_manual', JSON.stringify(manualData));
        
        // åŒæ—¶ä¿å­˜åˆ°å†å²è®°å½•
        const historyKey = 'assembly_manual_history';
        let history = [];
        
        try {
          const stored = localStorage.getItem(historyKey);
          if (stored) {
            history = JSON.parse(stored);
          }
        } catch (e) {
          console.warn('è¯»å–å†å²è®°å½•å¤±è´¥:', e);
        }

        const historyItem = {
          taskId: '2ca76253-b25e-45b9-9f88-c4c389bf0894',
          productName: manualData.metadata?.product_name || 'å‰æ¨é›ªæ¿æ€»æˆ',
          timestamp: new Date().toISOString(),
          data: manualData
        };

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existingIndex = history.findIndex(item => item.taskId === historyItem.taskId);
        if (existingIndex >= 0) {
          history[existingIndex] = historyItem;
        } else {
          history.unshift(historyItem);
          if (history.length > 10) {
            history = history.slice(0, 10);
          }
        }

        localStorage.setItem(historyKey, JSON.stringify(history));
        
        showStatus('success', 'âœ… å·²ä¿å­˜åˆ° localStorage å’Œå†å²è®°å½•');
      } catch (error) {
        showStatus('error', `âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
      }
    }

    function viewInManualViewer() {
      const taskId = '2ca76253-b25e-45b9-9f88-c4c389bf0894';
      window.location.href = `/manual/${taskId}`;
    }

    function clearStorage() {
      localStorage.removeItem('current_manual');
      localStorage.removeItem('assembly_manual_history');
      showStatus('success', 'âœ… å·²æ¸…ç©ºç¼“å­˜');
      manualData = null;
      document.getElementById('preview').innerHTML = '';
    }

    function showStatus(type, message) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
    }

    function showPreview() {
      const previewDiv = document.getElementById('preview');
      previewDiv.innerHTML = `
        <h3>ğŸ“Š æ•°æ®é¢„è§ˆï¼š</h3>
        <p><strong>äº§å“åç§°ï¼š</strong>${manualData.metadata?.product_name || 'æœªå‘½å'}</p>
        <p><strong>ç»„ä»¶æ•°é‡ï¼š</strong>${manualData.metadata?.total_components || 0}</p>
        <p><strong>äº§å“è£…é…æ­¥éª¤ï¼š</strong>${manualData.product_assembly?.steps?.length || 0} ä¸ª</p>
        <p><strong>ç»„ä»¶è£…é…æ­¥éª¤ï¼š</strong>${manualData.component_assembly?.length || 0} ä¸ª</p>
        <details>
          <summary>æŸ¥çœ‹å®Œæ•´ JSON</summary>
          <pre>${JSON.stringify(manualData, null, 2)}</pre>
        </details>
      `;
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼“å­˜
    window.onload = () => {
      const cached = localStorage.getItem('current_manual');
      if (cached) {
        showStatus('success', 'âœ… æ£€æµ‹åˆ°ç¼“å­˜æ•°æ®');
      }
    };
  </script>
</body>
</html>

