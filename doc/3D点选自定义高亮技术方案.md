# 3D 点选自定义高亮技术方案

## 目标与要解决的问题
- 目标：在手册查看器中，允许用户直接点击 3D 零件，手动设置其显示状态（当前/已装/隐藏），并即时反映到高亮渲染和步骤数据中，可保存到 assembly_manual.json。
- 解决的问题：
  1. 自动高亮不满足所有场景，用户需要覆盖颜色状态。
  2. 在已有/新生成的手册中都能使用，无需改后端或重新生成，只要有 node_name 即可。
  3. 针对点选不精确的小零件，提供辅助手段（爆炸、列表联动）。

## 范围与假设
- 仅前端改动（ManualViewer.vue）：三色渲染保持；新增“状态覆盖”交互和数据。
- 后端不改：继续提供 /api/manual/:taskId GET/PUT；保存时仍写回 assembly_manual.json。
- 数据前提：步骤中有可用的 node_name（来自 3d_highlight 或 parts/fasteners/parts_used），或可通过 BOM 映射表补齐。

## 数据结构设计
- 在步骤对象新增可选字段 `step_node_states`：
  ```json
  "step_node_states": {
    "NAUO1": "current",   // 黄
    "NAUO2": "done",      // 绿
    "NAUO3": "none"       // 隐藏/灰
  }
  ```
  - 仅存用户修改过的节点；未出现的节点按自动规则渲染。
  - 保存时写回 assembly_manual.json。

## 渲染逻辑调整（保持三色）
1) 计算节点列表：
   - `current_nodes_auto`：当前步骤的 3d_highlight/parts/fasteners/parts_used 的 node_name。
   - `done_nodes_auto`：前序步骤（同组件或产品）的 node_name。
2) 应用用户覆盖：
   - 若 `step_node_states` 存在，优先使用其中的状态（current/done/none）。
   - 未在 `step_node_states` 中的节点，仍按自动规则（当前=黄，前序=绿，其他=灰）。
3) 着色不变：黄/绿/浅灰半透。

## 交互设计
- 入口：在步骤面板加入“高亮编辑”按钮 → 抽屉/侧栏。
- 点选：
  - 场景启用 raycaster，点击 mesh 获取 node_name（normalize）。
  - 若该 node 在当前步骤节点列表中，弹出状态单选（当前/已装/隐藏）；选择后写入 `step_node_states` 并重新渲染。
  - 若不在列表但能从 manifest/BOM 找到匹配，提示“该节点不在当前步骤，是否添加并标记为当前？”（可选）。
- 列表联动（辅助）：
  - 抽屉内展示当前步骤节点列表 + 状态切换单选；搜索过滤。
  - 3D 点选 → 列表高亮；列表点击 → 3D 聚焦（可选）。
- 冲突提醒（可选简化版）：
  - 当用户将前序已装（绿）节点设为当前（黄）时，提示“此零件已在前序出现，继续将其设为当前？”；确认后以用户为准。

## 辅助功能（小件难点选）
- 爆炸视图：复用现有 manifest 的爆炸数据，提供切换按钮；爆炸状态下拾取节点。
- 容差：raycaster 使用包围盒命中，增大拾取容差。
- 过滤：仅渲染/拾取当前 GLB 的节点；产品/组件层级分开。

## 保存与缓存
- 保存：在抽屉中提供“保存更改”按钮，调用 `PUT /api/manual/:taskId` 提交整本 manual；更新 version 与 lastUpdated（后端已有逻辑）。
- 本地缓存：保存成功后更新 localStorage 的 current_manual，刷新仍保留用户设定。

## 开发步骤
1) 数据管道：为当前步骤增加 `step_node_states` 读取/写入（ManualViewer 状态）。
2) 渲染：在 `highlightStepParts` 中加入状态覆盖逻辑，优先 `step_node_states`，其余保持自动三色。
3) 点选：集成 raycaster，命中后弹状态选择（当前/已装/隐藏），写入状态并重渲染。
4) 抽屉 UI：节点列表 + 状态单选 + 搜索；支持从状态覆盖中恢复/重置。
5) 保存：绑定 PUT 接口，成功后更新缓存。
6) 辅助：爆炸模式拾取 + 提示/日志完善。

## 兼容与风险
- node_name 缺失：无法改色，需提示“当前步骤无可用节点”；可选从 BOM 映射补齐。
- 数据膨胀：`step_node_states` 仅存改过的节点，避免手册过大。
- 性能：大模型遍历着色已存在，继续复用；必要时节流/批量更新。

## 测试用例（手工）
- 加载已生成手册：默认三色正常。
- 点选节点改为当前/已装/隐藏，渲染即时变化，保存后刷新仍保持。
- 前序已装节点改为当前：出现提示，确认后生效。
- 爆炸模式：展开后点选小件能改色。
- 列表联动：点 3D → 列表高亮；列表切换状态 → 3D 颜色变化。
